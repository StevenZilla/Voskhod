---
- name: Copy backend sources
  copy:
    src: "{{ home_dir }}/sources/{{ backend }}.zip"
    dest: "{{ home_dir }}/{{ backend }}.zip"

- name: Copy frontend sources
  copy:
    src: "{{ home_dir }}/sources/{{ frontend }}.zip"
    dest: "{{ home_dir }}/{{ frontend }}.zip"

- name: Copy public API sources
  copy:
    src: "{{ home_dir }}/sources/{{ public_api }}.zip"
    dest: "{{ home_dir }}/{{ public_api }}.zip"

- name: Copy notification sources
  copy:
    src: "{{ home_dir }}/sources/{{ notification }}.zip"
    dest: "{{ home_dir }}/{{ notification }}.zip"

- name: Copy workers sources
  copy:
    src: "{{ home_dir }}/sources/{{ worker }}.zip"
    dest: "{{ home_dir }}/{{ worker }}.zip"

- name: Create deb-package directory
  file:
    path: "{{ home_dir }}/deployment/tr-archive-deb-package"
    state: directory
    owner: "{{ ansible_user }}"

- name: Unzip backend directory
  unarchive:
    src: "{{ home_dir }}/{{ backend }}.zip"
    dest: "{{ home_dir }}/deployment/tr-archive-deb-package"
  become: true

- name: Unzip frontend directory
  unarchive:
    src: "{{ home_dir }}/{{ frontend }}.zip"
    dest: "{{ home_dir }}/deployment/tr-archive-deb-package"
  become: true

- name: Unzip notification directory
  unarchive:
    src: "{{ home_dir }}/{{ notification }}.zip"
    dest: "{{ home_dir }}/deployment/tr-archive-deb-package"
  become: true

- name: Unzip worker directory
  unarchive:
    src: "{{ home_dir }}/{{ worker }}.zip"
    dest: "{{ home_dir }}/deployment/tr-archive-deb-package"
  become: true

- name: Unzip public API directory
  unarchive:
    src: "{{ home_dir }}/{{ public_api }}.zip"
    dest: "{{ home_dir }}/deployment/tr-archive-deb-package"
  become: true

- name: "composer install backend"
  shell: cd {{ home_dir }}/deployment/tr-archive-deb-package/{{ backend }} && composer install

- name: "composer install public API"
  shell: cd {{ home_dir }}/deployment/tr-archive-deb-package/{{ public_api }} && composer install

- name: "compose install notification"
  shell: cd {{ home_dir }}/deployment/tr-archive-deb-package/{{ notification }} && composer install

- name: "npm install and build frontend"
  shell: cd {{ home_dir }}/deployment/tr-archive-deb-package/{{ frontend }} && npm install && npm run build-v-dev

- name: "build deb package"
  shell: |
    cp -r {{ home_dir }}/deployment/debinstall {{ home_dir }}/deployment/tr-archive-deb-package/
    cd {{ home_dir }}/deployment/tr-archive-deb-package/debinstall && ./redeb.sh 

- name: "replace deb package to ansible workdir"
  shell: mv {{ home_dir }}/deployment/tr-archive-deb-package/debinstall/tr-archive.deb {{ home_dir }}/deployment/

- name: "remove tmp debinstall directory"
  shell: rm -rf {{ home_dir }}/deployment/tr-archive-deb-package/debinstall
